{% extends "base.html" %}
{% block title %}Гардероб{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
  <h1 class="text-2xl font-bold">Гардероб</h1>

  <!-- Мобильная кнопка фильтров -->
  <div class="lg:hidden">
    <button id="open-filters-btn" class="px-3 py-2 rounded-md border text-sm">Фильтры</button>
  </div>
</div>

<!-- ====== Табы + кнопка в одной строке ====== -->
<div class="mb-6 flex items-center justify-between">

  <!-- Табы -->
  <nav class="inline-flex rounded-md bg-white/60 p-1 shadow-sm">
    <a href="/wardrobe?view=all"
       class="px-4 py-2 text-sm rounded-md {% if view == 'all' %}bg-white font-semibold{% else %}text-slate-600{% endif %}">
       Все вещи
    </a>

    <a href="/wardrobe?view=categories"
       class="px-4 py-2 text-sm rounded-md {% if view == 'categories' %}bg-white font-semibold{% else %}text-slate-600{% endif %}">
       Категории
    </a>
  </nav>
  <!-- Кнопка добавления -->
  <button id="open-add-modal"
          class="px-4 py-2 rounded-md bg-[var(--accent)] text-white hover:bg-[var(--accent-dark)] text-sm shadow-sm">
    + Добавить
  </button>
</div>
<!-- ====== МОДАЛЬНОЕ ОКНО: загрузка вещи ====== -->
<div id="add-item-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" id="add-modal-backdrop"></div>

  <div class="relative w-full max-w-lg bg-white/95 backdrop-blur-xl rounded-[2.5rem] p-10 shadow-2xl border border-white z-50 transform transition-all">

    <div class="flex items-center justify-between mb-8">
      <div>
        <h3 class="text-2xl font-800 text-slate-900 tracking-tight">Новая вещь</h3>
        <p class="text-sm text-slate-500 mt-1">ИИ автоматически определит параметры</p>
      </div>
      <button id="close-add-modal" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-900 transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <form method="post" action="/wardrobe/add" enctype="multipart/form-data" class="space-y-6">
      <div class="relative group">
        <label class="block text-xs font-bold uppercase tracking-[0.1em] text-slate-400 mb-2 ml-1">Фотография</label>
        <div class="relative flex items-center justify-center w-full">
          <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-200 rounded-3xl cursor-pointer bg-slate-50/50 hover:bg-teal-50/30 hover:border-teal-300 transition-all duration-300 group">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg class="w-8 h-8 mb-2 text-slate-400 group-hover:text-teal-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <p class="text-xs text-slate-500 font-medium">Кликните для выбора файла</p>
            </div>
            <input type="file" name="file" accept="image/*" required class="hidden" />
          </label>
        </div>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase tracking-[0.1em] text-slate-400 mb-2 ml-1">Название (опционально)</label>
        <input type="text" name="name" placeholder="Белая футболка, синие джинсы..."
               class="w-full px-5 py-4 rounded-2xl border border-slate-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-500/5 outline-none transition-all text-sm bg-slate-50/30"/>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase tracking-[0.1em] text-slate-400 mb-2 ml-1">Материал</label>
        <input type="text" name="material" placeholder="Хлопок, Шерсть, Деним..."
               class="w-full px-5 py-4 rounded-2xl border border-slate-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-500/5 outline-none transition-all text-sm bg-slate-50/30"/>
      </div>

      <div class="flex gap-4 pt-4">
        <button type="button" id="close-add-modal-2"
                class="flex-1 px-6 py-4 rounded-2xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition-all">
          Отмена
        </button>
        <button type="submit"
                class="flex-[2] bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition-all shadow-xl shadow-black/10 active:scale-[0.98]">
          Загрузить вещь
        </button>
      </div>
    </form>
  </div>
</div>
<!-- ====== JS для открытия/закрытия модалки ====== -->
<script>
  // кнопки
  const openBtn = document.getElementById('open-add-modal');
  const fabBtn = document.getElementById('fab-open-add');
  const modal = document.getElementById('add-item-modal');
  const closeBtn = document.getElementById('close-add-modal');
  const closeBtn2 = document.getElementById('close-add-modal-2');
  const backdrop = document.getElementById('add-modal-backdrop');

  function showModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
  function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

  openBtn?.addEventListener('click', showModal);
  fabBtn?.addEventListener('click', showModal);
  closeBtn?.addEventListener('click', hideModal);
  closeBtn2?.addEventListener('click', hideModal);
  backdrop?.addEventListener('click', hideModal);

  // accessibility: Esc закрывает
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideModal(); });
</script>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
  <!-- SIDEBAR: занимает 3/12 колонок на lg -->
<aside id="filters-aside" class="hidden lg:block lg:col-span-3 card p-5 sticky top-20 h-fit z-30">
  <h3 class="font-semibold mb-4">Фильтры</h3>

  <!-- Форма отправляется GET на /wardrobe -->
  <form method="get" action="/wardrobe" id="filters-form">
    <input type="hidden" name="view" value="all" />

    <!-- ---- DROPDOWN: Категории ---- -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">Категории</label>

      <div class="relative inline-block w-full text-left">
        <button id="cat-toggle" type="button" class="w-full flex justify-between items-center px-3 py-2 rounded border text-sm bg-white">
          <span id="cat-label">Выбрать категории</span>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="cat-panel" class="hidden absolute left-0 mt-2 min-w-full w-max bg-white border rounded shadow-xl z-40 p-3">
          <div class="text-xs text-slate-500 mb-2">Можно выбрать несколько</div>

          {% for c in categories %}
            <label class="flex items-center gap-2 mb-1">
              <input type="checkbox" name="category" value="{{ c.name }}" class="filter-checkbox category-checkbox"
                     {% if selected_category_list and (c.name in selected_category_list) %}checked{% endif %}/>
              <span class="text-sm">{{ c.name }} <span class="text-xs text-slate-400">({{ c.count }})</span></span>
            </label>
          {% endfor %}

          <div class="mt-3 flex gap-2">
            <button type="submit" class="px-3 py-1 rounded bg-[var(--accent)] text-white text-sm">Применить</button>
            <button id="cat-clear" type="button" class="px-3 py-1 rounded border text-sm">Сбросить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ---- DROPDOWN: Цвета ---- -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">Цвет</label>
      <div class="relative inline-block w-full text-left">
        <button id="color-toggle" type="button" class="w-full flex justify-between items-center px-3 py-2 rounded border text-sm bg-white">
          <span id="color-label">Выбрать цвета</span>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="color-panel" class="hidden absolute left-0 mt-2 min-w-full w-max bg-white border rounded shadow-xl z-40 p-3">
          <div class="text-xs text-slate-500 mb-2">Можно выбрать несколько</div>

          {% for col in colors %}
            <label class="flex items-center gap-2 mb-1">
              <input type="checkbox" name="color" value="{{ col }}" class="filter-checkbox color-checkbox"
                     {% if selected_color_list and (col in selected_color_list) %}checked{% endif %}/>
              <span class="text-sm">{{ col }}</span>
            </label>
          {% endfor %}

          <div class="mt-3 flex gap-2">
            <button type="submit" class="px-3 py-1 rounded bg-[var(--accent)] text-white text-sm">Применить</button>
            <button id="color-clear" type="button" class="px-3 py-1 rounded border text-sm">Сбросить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ---- DROPDOWN: Материал ---- -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">Материал</label>
      <div class="relative inline-block w-full text-left">
        <button id="mat-toggle" type="button" class="w-full flex justify-between items-center px-3 py-2 rounded border text-sm bg-white">
          <span id="mat-label">Выбрать материалы</span>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="mat-panel" class="hidden absolute left-0 mt-2 min-w-full w-max bg-white border rounded shadow-xl z-40 p-3">
          <div class="text-xs text-slate-500 mb-2">Можно выбрать несколько</div>

          {% for m in materials %}
            <label class="flex items-center gap-2 mb-1">
              <input type="checkbox" name="material" value="{{ m }}" class="filter-checkbox material-checkbox"
                     {% if selected_material_list and (m in selected_material_list) %}checked{% endif %}/>
              <span class="text-sm">{{ m }}</span>
            </label>
          {% endfor %}

          <div class="mt-3 flex gap-2">
            <button type="submit" class="px-3 py-1 rounded bg-[var(--accent)] text-white text-sm">Применить</button>
            <button id="mat-clear" type="button" class="px-3 py-1 rounded border text-sm">Сбросить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Кнопки общие -->
    <div class="flex gap-2">
      <button type="submit" class="px-3 py-2 rounded bg-[var(--accent)] text-white text-sm">Применить</button>
      <a href="/wardrobe?view=all" class="px-3 py-2 rounded border text-sm">Сбросить</a>
    </div>
  </form>
</aside>

  <!-- MAIN CONTENT -->
  <main class="lg:col-span-9">
    {% if view == 'all' %}
      <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {% for item in items %}
          <a href="/wardrobe/item/{{ item.id }}/edit" class="card-modern group overflow-hidden bg-white block">
            <div class="relative aspect-[3/4] overflow-hidden bg-slate-100/50">
              <img src="/static/uploads/{{ item.file_id }}"
                   class="w-full h-full object-contain p-6 transition-transform duration-700 group-hover:scale-110"
                   alt="{{ item.category_ru }}">

              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                 <div class="opacity-0 group-hover:opacity-100 transition-opacity translate-y-4 group-hover:translate-y-0 duration-300">
                   <span class="px-4 py-2 bg-white rounded-full text-xs font-bold shadow-xl flex items-center gap-2">
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                     Изменить
                   </span>
                 </div>
              </div>
            </div>

            <div class="p-5">
              <div class="flex items-center justify-between mb-2">
                <span class="text-[10px] font-extrabold uppercase tracking-[0.1em] text-teal-600 bg-teal-50 px-2 py-0.5 rounded">
                  {{ item.category_ru }}
                </span>
                <div class="w-3 h-3 rounded-full border border-white shadow-sm" style="background-color: {{ item.color_en }}"></div>
              </div>
              <h3 class="font-bold text-slate-800 truncate text-sm group-hover:text-teal-600 transition-colors">
                {{ item.name or 'Базовая модель' }}
              </h3>
              {% if item.material %}
                <p class="text-[11px] text-slate-400 mt-1 font-medium">{{ item.material }}</p>
              {% endif %}
            </div>
          </a>
        {% endfor %}

        {% if not items %}
          <div class="col-span-full text-center text-slate-500">Пока нет добавленных вещей.</div>
        {% endif %}
      </section>
    {% elif view == 'categories' %}
      <section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for cat in categories %}
          <a href="/wardrobe?view=all&category={{ cat.name }}" class="group card block overflow-hidden rounded-lg hover:shadow-lg transition-all duration-300">
            <div class="w-full h-56 bg-white overflow-hidden flex items-center justify-center relative p-2 border-b border-slate-100">
              {% if cat.last_image %}
                <img src="/static/uploads/{{ cat.last_image }}"
                     alt="{{ cat.name }}"
                     class="max-h-full max-w-full object-contain group-hover:scale-105 transition duration-300 relative z-10"/>
              {% else %}
                <div class="flex flex-col items-center justify-center text-slate-300">
                  <svg class="w-10 h-10 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <span class="text-xs text-slate-400 font-medium">Нет фото</span>
                </div>
              {% endif %}
            </div>

            <div class="p-4 text-center bg-slate-50/50 group-hover:bg-white transition-colors">
              <div class="text-base font-bold text-slate-800">{{ cat.name }}</div>
              <div class="text-xs text-slate-500 font-medium mt-1 lowercase">вещей: {{ cat.count }}</div>
            </div>
          </a>
        {% endfor %}
      </section>
    {% endif %}
  </main>
</div>

<!-- MOBILE FILTER DRAWER (замена) -->
<div id="mobile-filters" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40" id="mobile-filters-backdrop"></div>
  <div class="absolute right-0 top-0 h-full w-full max-w-xs bg-white shadow-lg p-5 overflow-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold">Фильтры</h3>
      <button id="close-filters-btn" class="text-slate-600">Закрыть</button>
    </div>

    <form method="get" action="/wardrobe">
      <input type="hidden" name="view" value="all"/>
      <div class="mb-3">
        <label class="text-sm font-medium">Категории</label>
        <div class="mt-2 space-y-1">
          {% for c in categories %}
            <label class="flex items-center gap-2">
              <input type="checkbox" name="category" value="{{ c.name }}" {% if selected_category_list and (c.name in selected_category_list) %}checked{% endif %}/>
              <span class="text-sm">{{ c.name }} <span class="text-xs text-slate-400">({{ c.count }})</span></span>
            </label>
          {% endfor %}
        </div>
      </div>

      <div class="mb-3">
        <label class="text-sm font-medium">Цвет</label>
        <div class="mt-2 space-y-1">
          {% for col in colors %}
            <label class="flex items-center gap-2"><input type="checkbox" name="color" value="{{ col }}" {% if selected_color_list and (col in selected_color_list) %}checked{% endif %}/> <span class="text-sm">{{ col }}</span></label>
          {% endfor %}
        </div>
      </div>

      <div class="mb-3">
        <label class="text-sm font-medium">Материал</label>
        <div class="mt-2 space-y-1">
          {% for m in materials %}
            <label class="flex items-center gap-2"><input type="checkbox" name="material" value="{{ m }}" {% if selected_material_list and (m in selected_material_list) %}checked{% endif %}/> <span class="text-sm">{{ m }}</span></label>
          {% endfor %}
        </div>
      </div>

      <div class="flex gap-2 mt-4">
        <button type="submit" class="px-3 py-2 rounded bg-[var(--accent)] text-white text-sm">Применить</button>
        <a href="/wardrobe?view=all" class="px-3 py-2 rounded border text-sm">Сбросить</a>
      </div>
    </form>
  </div>
</div>

<!-- Минимальный JS для mobile drawer -->
<script>
  document.getElementById('open-filters-btn')?.addEventListener('click', () => {
    document.getElementById('mobile-filters').classList.remove('hidden');
  });
  document.getElementById('close-filters-btn')?.addEventListener('click', () => {
    document.getElementById('mobile-filters').classList.add('hidden');
  });
  document.getElementById('mobile-filters-backdrop')?.addEventListener('click', () => {
    document.getElementById('mobile-filters').classList.add('hidden');
  });
</script>
<script>
// helper: получить список выбранных чекбоксов по селектору
function getChecked(selector) {
  return Array.from(document.querySelectorAll(selector)).filter(cb => cb.checked).map(cb => cb.value);
}

// Toggle handlers
function setupToggle(toggleId, panelId, clearId, checkboxSelector, labelId, defaultLabel) {
  const btn = document.getElementById(toggleId);
  const panel = document.getElementById(panelId);
  const clearBtn = document.getElementById(clearId);
  const label = document.getElementById(labelId);

  if (!btn || !panel) return;

  btn.addEventListener('click', (e) => {
    e.stopPropagation();

    // --- НОВАЯ ЛОГИКА: Закрываем все остальные панели ---
    const allPanels = [
      document.getElementById('cat-panel'),
      document.getElementById('color-panel'),
      document.getElementById('mat-panel')
    ];

    allPanels.forEach(p => {
      if (p && p !== panel) {
        p.classList.add('hidden');
      }
    });
    // --------------------------------------------------

    panel.classList.toggle('hidden');
  });

  // Закрытие при клике в любое другое место экрана
  document.addEventListener('click', (e) => {
    if (!panel.contains(e.target) && !btn.contains(e.target)) {
      panel.classList.add('hidden');
    }
  });

  // (Остальной код функции про очистку и обновление лейблов остается без изменений)
  clearBtn?.addEventListener('click', () => {
    document.querySelectorAll(checkboxSelector).forEach(cb => cb.checked = false);
    updateLabel(checkboxSelector, label, defaultLabel);
  });

  updateLabel(checkboxSelector, label, defaultLabel);
  document.querySelectorAll(checkboxSelector).forEach(cb => {
    cb.addEventListener('change', () => updateLabel(checkboxSelector, label, defaultLabel));
  });
}
function updateLabel(checkboxSelector, labelEl, defaultLabel) {
  const checked = getChecked(checkboxSelector);
  if (!labelEl) return;
  if (checked.length === 0) {
    labelEl.textContent = defaultLabel;
  } else if (checked.length === 1) {
    labelEl.textContent = checked[0];
  } else {
    labelEl.textContent = `${checked.length} выбрано`;
  }
}

// initialize toggles (ids must match those in sidebar)
setupToggle('cat-toggle','cat-panel','cat-clear','.category-checkbox','cat-label','Выбрать категории');
setupToggle('color-toggle','color-panel','color-clear','.color-checkbox','color-label','Выбрать цвета');
setupToggle('mat-toggle','mat-panel','mat-clear','.material-checkbox','mat-label','Выбрать материалы');

// mobile drawer open/close (использовался ранее)
document.getElementById('open-filters-btn')?.addEventListener('click', () => {
  document.getElementById('mobile-filters').classList.remove('hidden');
});
document.getElementById('close-filters-btn')?.addEventListener('click', () => {
  document.getElementById('mobile-filters').classList.add('hidden');
});
document.getElementById('mobile-filters-backdrop')?.addEventListener('click', () => {
  document.getElementById('mobile-filters').classList.add('hidden');
});
</script>
{% endblock %}